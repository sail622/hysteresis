delta.error <- function(g){
  if (g$method=="nls") {
    lag.se.delta<-deltaMethod(g$fit, "(-atan (((sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))/ ((sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))) - atan((-(sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))/( (sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))))/(pi*2)")[[2]]*g$fit.statistics["period"]
    area.se.delta<-deltaMethod(g$fit,"sqrt((((ampx)^2+(ampy)^2+((ampx)^2-(ampy)^2)/((cos(theta))^2-(sin(theta))^2))/2)  )*sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2)*pi")[[2]]
  coercion.se.delta <- deltaMethod(g$fit,  "ampx*sin(-atan (((sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))/ ((sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))) - atan((-(sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))/( (sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))))" )[[2]]
  retention.se.delta <- deltaMethod(g$fit, "ampy*sin(-atan (((sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))/ ((sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))) - atan((-(sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))/( (sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))))" )[[2]]
  rotated.se.angle <- coef(summary(g$fit))[5,2]*180/pi
    split.angle = deltaMethod(g$fit, "(atan(sqrt(ampy^2-(ampy*sin(atan (((sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta))/ ((sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))) - atan((-(sqrt((ampx^2+ampy^2+(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*sin(theta))/( (-sqrt((ampx^2+ampy^2-(ampx^2-ampy^2)/((cos(theta))^2-(sin(theta))^2))/2))*cos(theta)))))^2)/ampx))*180/pi")[[2]]
  SE<-c(coef(summary(g$fit))[c(3,4),2],"rotated.angle"=rotated.se.angle,coef(summary(g$fit))[c(1,2),2],"area"=area.se.delta,"lag"=lag.se.delta,"retention"=retention.se.delta,"coercion"=coercion.se.delta,"split.angle"=split.angle)}
  else if (g$method=="lm") {
    angle.SE.delta<-deltaMethod(g$fit,"atan(xy/(1-y2))*90/pi")[[2]]
    cx.SE.delta<-deltaMethod(g$fit,"-(2*y2*x-xy*y)/(4*y2-xy*xy)")[[2]]
    cy.SE.delta<-deltaMethod(g$fit,"-(2*y-xy*x)/(4*y2-xy*xy)")[[2]]
    area.SE.delta<-deltaMethod(g$fit,"(1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) )))       *          (1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))) *pi")[[2]]
    if (g$coefficients["theta"] < pi/2) {
    ampx.SE.delta<-deltaMethod(g$fit,"sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2)")[[2]]
    ampy.SE.delta<-deltaMethod(g$fit,"sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2)")[[2]]
    lag.se.delta<-deltaMethod(g$fit,"( -atan((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))/(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))) -  atan((-((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))/ (((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))))/(pi*2)")[[2]]*g$fit.statistics["period"]
    coercion.se.delta<- deltaMethod(g$fit, "(sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2)")[[2]]
    retention.se.delta<- deltaMethod(g$fit,"(sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2)")[[2]]
    split.angle<-deltaMethod(g$fit, "atan(sqrt((sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))^2-((sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2))^2)/(sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2)))*180/pi")[[2]] 
    }
    else {
      ampx.SE.delta<-deltaMethod(g$fit,"sqrt((((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2)")[[2]]
      ampy.SE.delta<-deltaMethod(g$fit,"sqrt((((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2)")[[2]]
      lag.se.delta<-deltaMethod(g$fit, "( -atan((((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))/( ((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))) -  atan((-((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))/ (((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))))/(pi*2)")[[2]]*g$fit.statistics["period"]
      coercion.se.delta<- deltaMethod(g$fit,"(sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2)")[[2]]
      retention.se.delta<- deltaMethod(g$fit,"(sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2)")[[2]]
      split.angle<-deltaMethod(g$fit, "atan(sqrt((sqrt((((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))^2-((sqrt((((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2))*sin(atan(xy/(1-y2))/2-pi/2))^2)/(sqrt((((1/sqrt((1*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) - xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*cos(atan(xy/(1-y2))/2-pi/2))^2+(((1/sqrt((1*cos(atan(xy/(1-y2))/2-pi/2)*cos(atan(xy/(1-y2))/2-pi/2) + xy*cos(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2) + y2*sin(atan(xy/(1-y2))/2-pi/2)*sin(atan(xy/(1-y2))/2-pi/2)) / (1*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y2*x-xy*y)/(4*y2-xy*xy) + xy*(2*y2*x-xy*y)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) + y2*(2*y-xy*x)/(4*y2-xy*xy)*(2*y-xy*x)/(4*y2-xy*xy) - (int) ))))*sin(atan(xy/(1-y2))/2-pi/2))^2)))*180/pi")[[2]]
      
    }
        SE <- c("cx"=cx.SE.delta,"cy"=cy.SE.delta,"rotated.angle"=angle.SE.delta,"ampx"=ampx.SE.delta,
            "ampy"=ampy.SE.delta,"area"=area.SE.delta,"lag"=lag.se.delta,"retention"=retention.se.delta,"coercion"=coercion.se.delta,"split.angle"=split.angle)
    }
          else if (g$method=="direct") {
     stop("Delta errors not currently available for direct method ellipses. Use summary() to
          obtain bootstrap standard errors instead.")
    }
  else if(g$method=="harmonic2"){
    z <- g$fit[[1]]
    rss <- sum(z$residuals^2)
    p <- z$rank
    p1 <- 1L:p
    resvar1 <- rss/z$df.residual  
    R1 <- chol2inv(z$qr$qr[p1, p1, drop = FALSE])
    se1 <- sqrt(diag(R1) * resvar1)
   
    
    z2 <- g$fit[[2]]
    rss <- sum(z2$residuals^2)
    p <- z2$rank
    p1 <- 1L:p
    resvar2 <- rss/z2$df.residual  
    R2 <- chol2inv(z2$qr$qr[p1, p1, drop = FALSE])
    se2 <- sqrt(diag(R2) * resvar2)
  
    cov.Ta<- R1*resvar1
    cov.Tb<- R2*resvar2
    
    cov.matrix=matrix(c(cov.Ta[2,2],cov.Ta[2,3],0,0,cov.Ta[2,3],cov.Ta[3,3],0,0,0,0,cov.Tb[2,2],cov.Tb[2,3],0,0,cov.Tb[2,3],cov.Tb[3,3]),nrow=4)
    
    area<-deltamethod(~pi*sqrt(x1^2+x2^2)*sqrt(x3^2+x4^2)*sin(atan(-x1/x2)-atan(-x3/x4)),c(z$coefficients[-1],z2$coefficients[-1]), cov.matrix)
    retention<-deltamethod(~sqrt(x3^2+x4^2)*sin(atan(-x1/x2)-atan(-x3/x4)),c(z$coefficients[-1],z2$coefficients[-1]), cov.matrix)
    coercion<-deltamethod(~sqrt(x1^2+x2^2)*sin(atan(-x1/x2)-atan(-x3/x4)),c(z$coefficients[-1],z2$coefficients[-1]), cov.matrix)
    lag<-deltamethod(~12/pi*(atan(-x1/x2)-atan(-x3/x4)),c(z$coefficients[-1],z2$coefficients[-1]), cov.matrix)
    
    ampx<-deltamethod(~sqrt(x1^2+x2^2),z$coefficients[-1], cov.matrix[1:2,1:2])
    ampy<-deltamethod(~sqrt(x1^2+x2^2),z2$coefficients[-1], cov.matrix[3:4,3:4]) 
    split.angle<- deltamethod(~atan(sqrt(x2^2-(sqrt(x3^2+x4^2)*sin(atan(-x1/x2)-atan(-x3/x4)))^2)/x1)*180/pi, c(z$coefficients[-1],z2$coefficients[-1]), cov.matrix)
    
    SE <- c("cx"=se1[1],"cy"=se2[1],"rotated.angle"=NA,"ampx"=ampx,"ampy"=ampy,"area"=area,"lag"=lag,
"retention"=se2[2],"coercion"=coercion,"split.angle"=split.angle)
  }
SE
  }